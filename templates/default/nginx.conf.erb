worker_processes auto;
error_log <%= @load_balancer_log_dir %>/error.log;
pid /var/run/nginx.pid;

load_module <%= "#{@load_module};" %>

events {
  worker_connections 1024;
}

stream {
  map $ssl_preread_server_name $name {
    default  hopsworks;
  }

  upstream hopsworks {
    least_conn;
    <% @glassfish_nodes.each do |ipaddress, instance_name| %>
     server <%= "#{ipaddress}:#{node['hopsworks']['internal']['port']} max_fails=3 fail_timeout=5s;" %>
    <% end %>
  }

  server {
    ssl_preread on;
    listen <%= @load_balancer_port %>;
    listen [::]:<%= @load_balancer_port %>;
    proxy_pass $name;
 }
  log_format proxy '$remote_addr $protocol $status $bytes_sent $bytes_received $session_time $session_time $upstream_addr';
  access_log  <%= @load_balancer_log_dir %>/access.log proxy;
  error_log <%= @load_balancer_log_dir %>/error.log debug;
}